# 酒店空调管理系统 - 后端对接总文档

> 本文档整合了四个模块（客户端、管理员端、前台营业员端、酒店经理端）的所有接口规范。

---

## 📦 1. 项目概述

### 1.1 基本信息

- **项目名称**：酒店空调管理系统
- **前端技术栈**：Vue 3 + Pinia + Vue Router + Tailwind CSS + Axios + Socket.io
- **后端要求**：提供 HTTP API + WebSocket 实时通信
- **默认端口**：3000
- **房间范围**：301-350（共50个房间）

### 1.2 四个模块简介

| 模块 | 访问路径 | 主要功能 | 核心用户 |
|------|---------|---------|---------|
| **客户端** | `/room/:roomId` | 空调控制、温度调节、费用查询 | 酒店客人 |
| **管理员端** | `/admin` | 中央空调控制、队列管理、监控所有房间 | 系统管理员 |
| **前台营业员端** | `/reception` | 入住登记、账单生成、结账退房 | 前台服务员 |
| **酒店经理端** | `/manager` | 能耗统计、费用分析、经营报表 | 酒店经理 |

---

## 🚀 2. 快速开始

### 2.1 前端启动

```bash
# 进入项目目录
cd hotel-ac-frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev

# 访问地址
http://localhost:5173
```

### 2.2 后端服务要求

后端需要提供以下服务：

1. **HTTP API 服务**
   - 基础地址：`http://localhost:3000/api`
   - 内容类型：`application/json`
   - 需要支持 CORS 跨域请求

2. **WebSocket 服务**
   - 连接地址：`http://localhost:3000`
   - 使用 Socket.io 协议
   - 支持房间频道（room channels）

### 2.3 端口配置

前端默认配置（可在 `.env` 文件修改）：

```env
VITE_API_BASE_URL=http://localhost:3000/api
VITE_WS_URL=http://localhost:3000
VITE_APP_TITLE=酒店空调管理系统
```

### 2.4 环境变量配置

如果后端服务运行在不同端口，修改 `.env` 文件：

```env
VITE_API_BASE_URL=http://your-backend-url:port/api
VITE_WS_URL=http://your-backend-url:port
```

⚠️ **注意**：修改后需要重启前端开发服务器！

---

## 📋 3. 接口汇总（按模块分类）

### 3.1 客户端模块（Room Client）

**访问地址**: `http://localhost:5173/room/:roomId`

**核心功能**:
- 空调开关机控制
- 温度调节（±0.5°C）
- 风速切换（低/中/高）
- 实时温度显示
- 费用实时累加
- 服务状态监控

#### HTTP 接口清单

| 优先级 | 方法 | 路径 | 功能描述 |
|--------|------|------|---------|
| 🔴 | POST | `/api/ac/request-service` | 开机请求服务 |
| 🔴 | POST | `/api/ac/stop-service` | 关机停止服务 |
| 🔴 | POST | `/api/ac/set-temperature` | 设置目标温度 |
| 🔴 | POST | `/api/ac/set-fan-speed` | 设置风速档位 |
| 🔴 | GET | `/api/ac/room-status/:roomId` | 查询房间状态 |
| 🟡 | GET | `/api/ac/query-fee/:roomId` | 查询当前费用 |

#### WebSocket 事件清单

**客户端发送**:
- `join-room`: 加入房间频道
- `leave-room`: 离开房间频道

**服务端推送**:
- `temperature-update`: 温度更新（每2秒）
- `fee-update`: 费用更新（每2秒）
- `status-change`: 状态变化
- `service-started`: 服务开始
- `service-stopped`: 服务停止

---

### 3.2 管理员端模块（Admin）

**访问地址**: `http://localhost:5173/admin`

**核心功能**:
- 中央空调启停控制
- 监控所有房间状态
- 查看服务队列和等待队列
- 实时状态更新

#### HTTP 接口清单

| 优先级 | 方法 | 路径 | 功能描述 |
|--------|------|------|---------|
| 🔴 | GET | `/api/admin/central-ac/status` | 获取中央空调状态 |
| 🔴 | POST | `/api/admin/central-ac/start` | 启动中央空调 |
| 🔴 | POST | `/api/admin/central-ac/stop` | 关闭中央空调 |
| 🔴 | GET | `/api/admin/rooms` | 获取所有房间状态 |
| 🔴 | GET | `/api/admin/service-queue` | 获取服务队列 |
| 🔴 | GET | `/api/admin/waiting-queue` | 获取等待队列 |

#### WebSocket 事件清单

**客户端发送**:
- `join-admin`: 加入管理员频道
- `leave-admin`: 离开管理员频道

**服务端推送**:
- `central-ac-status`: 中央空调状态变化
- `queue-update`: 队列更新
- `room-power-on`: 房间开机通知
- `room-power-off`: 房间关机通知

---

### 3.3 前台营业员端模块（Reception）

**访问地址**: `http://localhost:5173/reception`

**核心功能**:
- 查询可用房间
- 办理入住登记
- 生成账单（住宿费+空调费）
- 查看空调使用详单
- 完成结账退房

#### HTTP 接口清单

| 优先级 | 方法 | 路径 | 功能描述 |
|--------|------|------|---------|
| 🔴 | GET | `/api/reception/rooms` | 获取所有房间列表 |
| 🔴 | GET | `/api/reception/available-rooms` | 查询可用房间 |
| 🔴 | POST | `/api/reception/check-in` | 办理入住 |
| 🔴 | GET | `/api/reception/customer/:roomId` | 查询客户信息 |
| 🔴 | POST | `/api/reception/generate-bill` | 生成账单 |
| 🟡 | GET | `/api/reception/bill-detail/:roomId` | 获取空调使用详单 |
| 🔴 | POST | `/api/reception/check-out` | 完成结账 |

---

### 3.4 酒店经理端模块（Manager）

**访问地址**: `http://localhost:5173/manager`

**核心功能**:
- 查看所有房间能耗报表
- 能耗统计分析
- 每日能耗趋势图
- 费用分析
- 高能耗房间提醒

#### HTTP 接口清单

| 优先级 | 方法 | 路径 | 功能描述 |
|--------|------|------|---------|
| 🟡 | GET | `/api/manager/room-reports` | 获取所有房间报表 |
| 🟡 | GET | `/api/manager/room-report/:roomId` | 获取单个房间详细报表 |
| 🟡 | GET | `/api/manager/energy-stats` | 获取整体能耗统计 |
| 🟡 | GET | `/api/manager/daily-stats` | 获取每日统计数据 |

---

## 📝 4. 通用数据格式

### 4.1 响应格式

所有接口统一使用以下响应格式：

#### 成功响应
```json
{
  "success": true,
  "data": { ... },
  "message": "操作成功"  // 可选
}
```

#### 失败响应
```json
{
  "success": false,
  "message": "错误描述信息",
  "errorCode": "ERROR_CODE"  // 可选
}
```

### 4.2 通用数据类型

#### 房间状态枚举
```typescript
status: "available" | "occupied" | "cleaning"  // 房间状态
```

#### 房型枚举
```typescript
roomType: "single" | "double" | "king"  // 房型
```

#### 空调模式枚举
```typescript
mode: "Cooling" | "Heating"  // 制冷/制热
```

#### 风速枚举
```typescript
fanSpeed: "Low" | "Mid" | "High"  // 低风/中风/高风
```

#### 服务状态枚举
```typescript
serviceStatus: "idle" | "serving" | "waiting"  // 空闲/服务中/等待中
```

#### 支付方式枚举
```typescript
paymentMethod: "cash" | "wechat" | "alipay" | "card"  // 现金/微信/支付宝/银行卡
```

---

## 🔧 5. 详细接口说明

### 5.1 客户端接口详细说明

#### 5.1.1 开机接口

```http
POST /api/ac/request-service
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomId | string | ✅ | 房间号 |
| currentTemp | number | ✅ | 当前温度 |

**请求示例**:
```json
{
  "roomId": "301",
  "currentTemp": 28.0
}
```

**成功响应**:
```json
{
  "success": true,
  "mode": "Cooling",
  "targetTemp": 25.0,
  "fanSpeed": "Mid",
  "feeRate": 0.8,
  "status": "serving",
  "waitTime": 0
}
```

**失败响应**:
```json
{
  "success": false,
  "message": "中央空调未启动"
}
```

**业务规则**:
- 中央空调必须已启动
- 初始风速默认为"中风"
- 制冷模式初始目标温度 25°C，制热模式 26°C
- 服务队列未满时 status 为 "serving"，已满时为 "waiting"

---

#### 5.1.2 关机接口

```http
POST /api/ac/stop-service
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomId | string | ✅ | 房间号 |

**请求示例**:
```json
{
  "roomId": "301"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "关机成功"
}
```

**业务规则**:
- 关机后从服务队列/等待队列中移除
- 费用保留，不清零
- 更新统计数据（总使用时长、总能耗等）

---

#### 5.1.3 设置温度接口

```http
POST /api/ac/set-temperature
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomId | string | ✅ | 房间号 |
| targetTemp | number | ✅ | 目标温度 |

**请求示例**:
```json
{
  "roomId": "301",
  "targetTemp": 24.5
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "温度设置成功"
}
```

**业务规则**:
- 制冷模式：18°C - 25°C
- 制热模式：25°C - 30°C
- 前端已做限制，后端建议再次验证

---

#### 5.1.4 设置风速接口

```http
POST /api/ac/set-fan-speed
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomId | string | ✅ | 房间号 |
| fanSpeed | string | ✅ | 风速档位 (Low/Mid/High) |

**请求示例**:
```json
{
  "roomId": "301",
  "fanSpeed": "High"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "风速设置成功",
  "statusChanged": false,
  "newStatus": "serving",
  "waitTime": 0
}
```

**响应字段说明**:
| 字段 | 说明 |
|------|------|
| statusChanged | 是否触发了优先级调度（高风速可能抢占低风速） |
| newStatus | 新的服务状态 |
| waitTime | 如果被挂起，预计等待时间（秒） |

**业务规则**:
- 更新费率：Low 0.5元/分钟，Mid 0.8元/分钟，High 1.0元/分钟
- 可能触发优先级调度（可选功能）

---

#### 5.1.5 查询房间状态接口

```http
GET /api/ac/room-status/:roomId
```

**请求示例**:
```
GET /api/ac/room-status/301
```

**成功响应**:
```json
{
  "success": true,
  "isPowerOn": true,
  "currentTemp": 26.5,
  "targetTemp": 25.0,
  "fanSpeed": "Mid",
  "mode": "Cooling",
  "totalFee": 12.50,
  "feeRate": 0.8,
  "status": "serving",
  "waitTime": 0
}
```

**业务规则**:
- 用于页面初始化，获取房间当前状态
- 即使房间未开机，也应返回默认状态

---

#### 5.1.6 查询费用接口

```http
GET /api/ac/query-fee/:roomId
```

**请求示例**:
```
GET /api/ac/query-fee/301
```

**成功响应**:
```json
{
  "success": true,
  "totalFee": 12.50
}
```

**业务规则**:
- 返回当前累计费用
- 费用单位：元（保留2位小数）

---

### 5.2 管理员端接口详细说明

#### 5.2.1 获取所有房间状态

```http
GET /api/admin/rooms
```

**成功响应**:
```json
{
  "success": true,
  "rooms": [
    {
      "roomId": "301",
      "isPowerOn": true,
      "currentTemp": 26.5,
      "targetTemp": 25.0,
      "fanSpeed": "Mid",
      "mode": "Cooling",
      "status": "serving",
      "totalFee": 12.50
    },
    {
      "roomId": "302",
      "isPowerOn": false,
      "currentTemp": 28.0,
      "targetTemp": 25.0,
      "fanSpeed": "Mid",
      "mode": "Cooling",
      "status": "idle",
      "totalFee": 0
    }
    // ... 所有 50 个房间
  ]
}
```

**业务规则**:
- 返回所有 50 个房间（301-350）
- 包含每个房间的实时状态

---

#### 5.2.2 获取中央空调状态

```http
GET /api/admin/central-ac/status
```

**成功响应**:
```json
{
  "success": true,
  "isRunning": true,
  "mode": "Cooling",
  "maxServing": 30,
  "currentServing": 12
}
```

**响应字段说明**:
| 字段 | 说明 |
|------|------|
| isRunning | 是否运行中 |
| mode | 工作模式（Cooling/Heating） |
| maxServing | 最大同时服务数 |
| currentServing | 当前服务房间数 |

---

#### 5.2.3 启动中央空调

```http
POST /api/admin/central-ac/start
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| mode | string | ✅ | 工作模式 (Cooling/Heating) |

**请求示例**:
```json
{
  "mode": "Cooling"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "中央空调已启动"
}
```

**业务规则**:
- 启动后所有房间才能开机
- 需要通过 WebSocket 广播状态变化

---

#### 5.2.4 关闭中央空调

```http
POST /api/admin/central-ac/stop
```

**成功响应**:
```json
{
  "success": true,
  "message": "中央空调已关闭"
}
```

**业务规则**:
- 关闭后所有房间空调自动关闭
- 清空服务队列和等待队列
- 通过 WebSocket 通知所有房间

---

#### 5.2.5 获取服务队列

```http
GET /api/admin/service-queue
```

**成功响应**:
```json
{
  "success": true,
  "queue": [
    {
      "roomId": "301",
      "fanSpeed": "High",
      "currentTemp": 26.5,
      "targetTemp": 25.0,
      "startTime": "2025-01-15T10:30:00Z"
    },
    {
      "roomId": "305",
      "fanSpeed": "Mid",
      "currentTemp": 27.0,
      "targetTemp": 25.0,
      "startTime": "2025-01-15T10:32:00Z"
    }
    // ... 最多 30 个
  ]
}
```

---

#### 5.2.6 获取等待队列

```http
GET /api/admin/waiting-queue
```

**成功响应**:
```json
{
  "success": true,
  "queue": [
    {
      "roomId": "308",
      "fanSpeed": "Low",
      "waitTime": 30,
      "requestTime": "2025-01-15T10:35:00Z"
    }
    // ...
  ]
}
```

---

### 5.3 前台营业员端接口详细说明

#### 5.3.1 获取所有房间列表

```http
GET /api/reception/rooms
```

**成功响应**:
```json
{
  "success": true,
  "rooms": [
    {
      "roomId": "301",
      "roomType": "single",
      "status": "available",
      "customer": null
    },
    {
      "roomId": "302",
      "roomType": "double",
      "status": "occupied",
      "customer": {
        "name": "张三",
        "phone": "13800138000",
        "checkInTime": "2025-01-15T14:00:00Z"
      }
    }
    // ... 所有房间
  ]
}
```

**房型说明**:
| roomType | 名称 | 价格 |
|----------|------|------|
| single | 单人房 | ¥128/晚 |
| double | 双人房 | ¥168/晚 |
| king | 大床房 | ¥198/晚 |

**房间状态**:
| status | 说明 |
|--------|------|
| available | 空闲可用 |
| occupied | 已入住 |
| cleaning | 清洁中 |

---

#### 5.3.2 查询可用房间

```http
GET /api/reception/available-rooms?roomType=single
```

**Query 参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomType | string | ❌ | 房型筛选 (single/double/king/all) |
| checkInDate | string | ❌ | 入住日期 |
| checkOutDate | string | ❌ | 退房日期 |

**请求示例**:
```
GET /api/reception/available-rooms?roomType=single&checkInDate=2025-01-15&checkOutDate=2025-01-16
```

**成功响应**:
```json
{
  "success": true,
  "rooms": [
    {
      "roomId": "301",
      "roomType": "single",
      "price": 128
    },
    {
      "roomId": "303",
      "roomType": "single",
      "price": 128
    }
  ]
}
```

---

#### 5.3.3 办理入住

```http
POST /api/reception/check-in
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomId | string | ✅ | 房间号 |
| customerName | string | ✅ | 客户姓名 |
| idCard | string | ✅ | 身份证号 |
| phone | string | ✅ | 手机号 |
| checkInDate | string | ✅ | 入住日期 (YYYY-MM-DD) |
| checkOutDate | string | ✅ | 退房日期 (YYYY-MM-DD) |

**请求示例**:
```json
{
  "roomId": "301",
  "customerName": "张三",
  "idCard": "110101199001011234",
  "phone": "13800138000",
  "checkInDate": "2025-01-15",
  "checkOutDate": "2025-01-16"
}
```

**成功响应**:
```json
{
  "success": true,
  "customerId": "C20250115001",
  "roomCardData": {
    "roomId": "301",
    "validFrom": "2025-01-15T14:00:00Z",
    "validTo": "2025-01-16T12:00:00Z"
  }
}
```

**失败响应**:
```json
{
  "success": false,
  "message": "该房间已被入住"
}
```

**业务规则**:
- 只能入住 status 为 "available" 的房间
- 入住后房间状态变为 "occupied"
- 生成唯一的客户ID

---

#### 5.3.4 查询房间客户信息

```http
GET /api/reception/customer/:roomId
```

**请求示例**:
```
GET /api/reception/customer/301
```

**成功响应**:
```json
{
  "success": true,
  "customer": {
    "customerId": "C20250115001",
    "name": "张三",
    "idCard": "110101199001011234",
    "phone": "13800138000",
    "checkInTime": "2025-01-15T14:30:00Z",
    "expectedCheckOutTime": "2025-01-16T12:00:00Z"
  }
}
```

**失败响应**:
```json
{
  "success": false,
  "message": "该房间无客户"
}
```

---

#### 5.3.5 生成账单

```http
POST /api/reception/generate-bill
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomId | string | ✅ | 房间号 |

**请求示例**:
```json
{
  "roomId": "301"
}
```

**成功响应**:
```json
{
  "success": true,
  "accommodationFee": 128.00,
  "acFee": 15.50,
  "totalFee": 143.50,
  "checkInTime": "2025-01-15T14:30:00Z",
  "checkOutTime": "2025-01-16T10:30:00Z",
  "duration": 1
}
```

**费用计算公式**:
```
住宿费 = 房价 × 入住天数（不足一天按一天计）
空调费 = 从空调系统获取该房间的 totalFee
总费用 = 住宿费 + 空调费
```

---

#### 5.3.6 获取空调使用详单

```http
GET /api/reception/bill-detail/:roomId
```

**请求示例**:
```
GET /api/reception/bill-detail/301
```

**成功响应**:
```json
{
  "success": true,
  "details": [
    {
      "startTime": "2025-01-15T15:00:00Z",
      "endTime": "2025-01-15T18:30:00Z",
      "fanSpeed": "Mid",
      "targetTemp": 25,
      "mode": "Cooling",
      "duration": 210,
      "fee": 6.30
    },
    {
      "startTime": "2025-01-15T22:00:00Z",
      "endTime": "2025-01-16T07:00:00Z",
      "fanSpeed": "Low",
      "targetTemp": 26,
      "mode": "Cooling",
      "duration": 540,
      "fee": 9.20
    }
  ]
}
```

**业务规则**:
- 按使用时段分段记录
- 每个时段包含风速、温度、时长、费用

---

#### 5.3.7 完成结账

```http
POST /api/reception/check-out
Content-Type: application/json
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roomId | string | ✅ | 房间号 |
| amountPaid | number | ✅ | 支付金额 |
| paymentMethod | string | ✅ | 支付方式 (cash/wechat/alipay/card) |

**请求示例**:
```json
{
  "roomId": "301",
  "amountPaid": 143.50,
  "paymentMethod": "wechat"
}
```

**成功响应**:
```json
{
  "success": true,
  "transactionId": "TXN20250116103000001",
  "receipt": {
    "roomId": "301",
    "customerName": "张三",
    "checkInTime": "2025-01-15T14:30:00Z",
    "checkOutTime": "2025-01-16T10:30:00Z",
    "accommodationFee": 128.00,
    "acFee": 15.50,
    "totalFee": 143.50,
    "amountPaid": 143.50,
    "paymentMethod": "wechat",
    "transactionId": "TXN20250116103000001"
  }
}
```

**业务规则**:
- 结账后房间状态变为 "available"
- 清空客户信息
- 空调费用归零
- 生成交易凭证

---

### 5.4 酒店经理端接口详细说明

#### 5.4.1 获取所有房间的报表数据

```http
GET /api/manager/room-reports?startDate=2025-01-01&endDate=2025-01-15
```

**Query 参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| startDate | string | ✅ | 开始日期 (YYYY-MM-DD) |
| endDate | string | ✅ | 结束日期 (YYYY-MM-DD) |

**成功响应**:
```json
{
  "success": true,
  "reports": [
    {
      "roomId": "301",
      "isActive": true,
      "totalDuration": 1200,
      "totalEnergy": 45.6,
      "totalFee": 68.40,
      "avgTemperature": 24.5,
      "mainFanSpeed": "Mid",
      "fanSpeedDistribution": {
        "Low": 30,
        "Mid": 50,
        "High": 20
      },
      "peakHours": "14:00-18:00"
    }
    // ... 其他房间
  ]
}
```

**响应字段说明**:
| 字段 | 说明 |
|------|------|
| isActive | 当前是否开机 |
| totalDuration | 总使用时长（分钟） |
| totalEnergy | 总能耗（kWh） |
| totalFee | 总费用（元） |
| avgTemperature | 平均设定温度 |
| mainFanSpeed | 主要风速（使用最多的） |
| fanSpeedDistribution | 风速使用分布（百分比） |
| peakHours | 高峰使用时段 |

---

#### 5.4.2 获取单个房间的详细报表

```http
GET /api/manager/room-report/:roomId?startDate=2025-01-01&endDate=2025-01-15
```

**请求示例**:
```
GET /api/manager/room-report/301?startDate=2025-01-01&endDate=2025-01-15
```

**成功响应**:
```json
{
  "success": true,
  "report": {
    "roomId": "301",
    "isActive": true,
    "totalDuration": 1200,
    "totalEnergy": 45.6,
    "totalFee": 68.40,
    "avgTemperature": 24.5,
    "mainFanSpeed": "Mid",
    "fanSpeedDistribution": {
      "Low": 30,
      "Mid": 50,
      "High": 20
    },
    "peakHours": "14:00-18:00",
    "dailyUsage": [
      {
        "date": "2025-01-01",
        "duration": 180,
        "energy": 5.4,
        "fee": 8.10
      },
      {
        "date": "2025-01-02",
        "duration": 210,
        "energy": 6.3,
        "fee": 9.45
      }
      // ... 每日数据
    ]
  }
}
```

---

#### 5.4.3 获取酒店整体能耗统计

```http
GET /api/manager/energy-stats?startDate=2025-01-01&endDate=2025-01-15
```

**成功响应**:
```json
{
  "success": true,
  "totalEnergy": 1234.56,
  "totalFee": 1851.84,
  "activeRooms": 32,
  "avgTemperature": 24.2,
  "peakHour": "15:00-17:00",
  "dailyAvgEnergy": 82.30
}
```

**响应字段说明**:
| 字段 | 说明 |
|------|------|
| totalEnergy | 总能耗（kWh） |
| totalFee | 总费用（元） |
| activeRooms | 当前开机房间数 |
| avgTemperature | 平均设定温度 |
| peakHour | 用电高峰时段 |
| dailyAvgEnergy | 日均能耗 |

---

#### 5.4.4 获取每日统计数据

```http
GET /api/manager/daily-stats?startDate=2025-01-01&endDate=2025-01-15
```

**成功响应**:
```json
{
  "success": true,
  "stats": [
    {
      "date": "2025-01-01",
      "energy": 78.5,
      "fee": 117.75,
      "activeRooms": 28,
      "avgTemperature": 24.0
    },
    {
      "date": "2025-01-02",
      "energy": 85.2,
      "fee": 127.80,
      "activeRooms": 35,
      "avgTemperature": 24.5
    }
    // ... 其他日期
  ]
}
```

**业务规则**:
- 用于前端绘制能耗趋势图
- 按日期排序

---

## 📡 6. WebSocket 事件详细说明

### 6.1 客户端 WebSocket 事件

#### 客户端发送事件

##### join-room - 加入房间频道
```javascript
socket.emit('join-room', { roomId: '301' });
```

**使用场景**: 客户端连接成功后立即发送，用于接收该房间的实时更新。

##### leave-room - 离开房间频道
```javascript
socket.emit('leave-room', { roomId: '301' });
```

**使用场景**: 客户端断开前发送，停止接收该房间的更新。

---

#### 服务端推送事件

##### temperature-update - 温度更新
```javascript
socket.to('room-301').emit('temperature-update', {
  roomId: '301',
  currentTemp: 26.5
});
```

**推送频率**: 每2秒
**推送条件**: 房间开机且正在服务中

##### fee-update - 费用更新
```javascript
socket.to('room-301').emit('fee-update', {
  roomId: '301',
  totalFee: 12.50
});
```

**推送频率**: 每2秒
**推送条件**: 房间开机且正在服务中

##### status-change - 状态变化
```javascript
socket.to('room-301').emit('status-change', {
  roomId: '301',
  status: 'waiting',
  waitTime: 30
});
```

**推送时机**: 服务状态改变时（serving ↔ waiting）

##### service-started - 服务开始
```javascript
socket.to('room-301').emit('service-started', {
  roomId: '301'
});
```

**推送时机**: 从等待队列进入服务队列时

##### service-stopped - 服务停止
```javascript
socket.to('room-301').emit('service-stopped', {
  roomId: '301'
});
```

**推送时机**: 关机或中央空调关闭时

---

### 6.2 管理员 WebSocket 事件

#### 客户端发送事件

##### join-admin - 加入管理员频道
```javascript
socket.emit('join-admin');
```

##### leave-admin - 离开管理员频道
```javascript
socket.emit('leave-admin');
```

---

#### 服务端推送事件

##### central-ac-status - 中央空调状态变化
```javascript
socket.to('admin').emit('central-ac-status', {
  isRunning: true,
  mode: 'Cooling',
  currentServing: 15
});
```

**推送时机**: 中央空调启动/关闭时

##### queue-update - 队列更新
```javascript
socket.to('admin').emit('queue-update', {
  serviceQueue: [...],
  waitingQueue: [...]
});
```

**推送时机**: 队列发生变化时（房间开关机、状态改变）

##### room-power-on - 房间开机通知
```javascript
socket.to('admin').emit('room-power-on', {
  roomId: '301',
  status: 'serving'
});
```

##### room-power-off - 房间关机通知
```javascript
socket.to('admin').emit('room-power-off', {
  roomId: '301'
});
```

---

## 🎯 7. 接口优先级与实现建议

### 第一阶段：核心功能（必须先实现）🔴

#### 客户端模块
1. ✅ POST `/api/ac/request-service` - 开机
2. ✅ POST `/api/ac/stop-service` - 关机
3. ✅ POST `/api/ac/set-temperature` - 设置温度
4. ✅ POST `/api/ac/set-fan-speed` - 设置风速
5. ✅ GET `/api/ac/room-status/:roomId` - 查询状态
6. ✅ WebSocket 温度和费用推送

#### 管理员模块
1. ✅ GET `/api/admin/central-ac/status` - 获取中央空调状态
2. ✅ POST `/api/admin/central-ac/start` - 启动中央空调
3. ✅ POST `/api/admin/central-ac/stop` - 关闭中央空调
4. ✅ GET `/api/admin/rooms` - 获取所有房间状态

---

### 第二阶段：辅助功能（可以后做）🟡

#### 前台营业员模块
1. ✅ GET `/api/reception/rooms` - 获取房间列表
2. ✅ POST `/api/reception/check-in` - 办理入住
3. ✅ POST `/api/reception/generate-bill` - 生成账单
4. ✅ POST `/api/reception/check-out` - 完成结账

#### 管理员模块扩展
1. ✅ GET `/api/admin/service-queue` - 服务队列
2. ✅ GET `/api/admin/waiting-queue` - 等待队列

---

### 第三阶段：统计报表（后期优化）🟢

#### 酒店经理模块
1. ⭕ GET `/api/manager/room-reports` - 房间报表
2. ⭕ GET `/api/manager/energy-stats` - 能耗统计
3. ⭕ GET `/api/manager/daily-stats` - 每日统计

---

## 🧪 8. 测试说明

### 8.1 使用 mock-server.js 测试

项目已提供完整的 mock 服务器用于前端测试。

#### 启动 Mock Server
```bash
cd hotel-ac-frontend
npm run mock
```

Mock Server 提供：
- ✅ 所有 23 个 HTTP 接口
- ✅ WebSocket 实时通信
- ✅ 50 个房间（301-350）的模拟数据
- ✅ 服务队列管理（最多30个服务中）
- ✅ 费用实时累加
- ✅ 温度模拟变化

---

### 8.2 验证接口是否正确

#### 使用 Postman 测试

**测试开机接口**:
```http
POST http://localhost:3000/api/ac/request-service
Content-Type: application/json

{
  "roomId": "301",
  "currentTemp": 28.0
}
```

**预期返回**:
```json
{
  "success": true,
  "mode": "Cooling",
  "targetTemp": 25.0,
  "fanSpeed": "Mid",
  "feeRate": 0.8,
  "status": "serving",
  "waitTime": 0
}
```

---

#### 使用前端界面测试

1. 启动后端（或 mock server）
2. 启动前端：`npm run dev`
3. 访问：`http://localhost:5173/room/301`
4. 测试流程：
   - ✅ 点击"开启电源"，检查状态变化
   - ✅ 调节温度，观察温度变化
   - ✅ 切换风速，检查费率更新
   - ✅ 观察费用累加
   - ✅ 点击"关闭电源"，检查状态恢复

---

### 8.3 WebSocket 测试

使用浏览器开发者工具：

1. 打开控制台（F12）
2. 查看 Network → WS（WebSocket）
3. 观察消息推送：
   - `temperature-update` 每2秒一次
   - `fee-update` 每2秒一次
   - 状态变化时的通知

---

### 8.4 常见问题排查

#### Q1: 前端显示"服务器无响应"

**检查清单**:
- ✅ 后端是否启动
- ✅ 端口是否是 3000
- ✅ CORS 是否配置（允许来自 `http://localhost:5173` 的请求）
- ✅ 防火墙是否阻止

**解决方案**:
```javascript
// 后端需要配置 CORS
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST']
}));
```

---

#### Q2: WebSocket 连接失败

**检查清单**:
- ✅ Socket.io 是否安装
- ✅ WebSocket 端口是否正确（与 HTTP 同端口）
- ✅ 事件名是否匹配（join-room、temperature-update 等）

**解决方案**:
```javascript
// 后端使用 Socket.io
import { Server } from 'socket.io';
const io = new Server(httpServer, {
  cors: {
    origin: '*',
    methods: ['GET', 'POST']
  }
});
```

---

#### Q3: 接口返回 404

**检查清单**:
- ✅ 路由路径是否正确
- ✅ 是否有 `/api` 前缀
- ✅ HTTP 方法是否匹配（GET/POST）

**解决方案**:
- 确保所有路由都有 `/api` 前缀
- 检查路由注册顺序

---

#### Q4: 费用一直显示 0

**检查清单**:
- ✅ 费率配置是否正确（Low 0.5, Mid 0.8, High 1.0）
- ✅ 费用累加逻辑是否运行
- ✅ WebSocket 是否推送 `fee-update` 事件

**解决方案**:
```javascript
// 每2秒更新费用
const feeIncrement = room.feeRate * (2 / 60);
room.totalFee += feeIncrement;
room.totalFee = Math.round(room.totalFee * 100) / 100;

io.to(`room-${roomId}`).emit('fee-update', {
  roomId,
  totalFee: room.totalFee
});
```

---

#### Q5: 温度不变化

**检查清单**:
- ✅ 是否在服务中（status === 'serving'）
- ✅ 温度更新逻辑是否运行
- ✅ WebSocket 是否推送 `temperature-update` 事件

**解决方案**:
```javascript
// 温度向目标温度靠近
const tempDiff = room.targetTemp - room.currentTemp;
if (Math.abs(tempDiff) > 0.1) {
  room.currentTemp += tempDiff * 0.1;  // 每次靠近10%
  room.currentTemp = Math.round(room.currentTemp * 10) / 10;

  io.to(`room-${roomId}`).emit('temperature-update', {
    roomId,
    currentTemp: room.currentTemp
  });
}
```

---

## 📊 9. 附录

### 9.1 所有接口完整清单（表格）

| 模块 | 方法 | 路径 | 功能 | 优先级 |
|------|------|------|------|--------|
| **客户端** |
| | POST | `/api/ac/request-service` | 开机 | 🔴 |
| | POST | `/api/ac/stop-service` | 关机 | 🔴 |
| | POST | `/api/ac/set-temperature` | 设置温度 | 🔴 |
| | POST | `/api/ac/set-fan-speed` | 设置风速 | 🔴 |
| | GET | `/api/ac/room-status/:roomId` | 查询状态 | 🔴 |
| | GET | `/api/ac/query-fee/:roomId` | 查询费用 | 🟡 |
| **管理员** |
| | GET | `/api/admin/central-ac/status` | 获取中央空调状态 | 🔴 |
| | POST | `/api/admin/central-ac/start` | 启动中央空调 | 🔴 |
| | POST | `/api/admin/central-ac/stop` | 关闭中央空调 | 🔴 |
| | GET | `/api/admin/rooms` | 获取所有房间状态 | 🔴 |
| | GET | `/api/admin/service-queue` | 获取服务队列 | 🟡 |
| | GET | `/api/admin/waiting-queue` | 获取等待队列 | 🟡 |
| **前台营业员** |
| | GET | `/api/reception/rooms` | 获取所有房间列表 | 🔴 |
| | GET | `/api/reception/available-rooms` | 查询可用房间 | 🔴 |
| | POST | `/api/reception/check-in` | 办理入住 | 🔴 |
| | GET | `/api/reception/customer/:roomId` | 查询客户信息 | 🔴 |
| | POST | `/api/reception/generate-bill` | 生成账单 | 🔴 |
| | GET | `/api/reception/bill-detail/:roomId` | 获取空调使用详单 | 🟡 |
| | POST | `/api/reception/check-out` | 完成结账 | 🔴 |
| **酒店经理** |
| | GET | `/api/manager/room-reports` | 获取所有房间报表 | 🟡 |
| | GET | `/api/manager/room-report/:roomId` | 获取单个房间详细报表 | 🟡 |
| | GET | `/api/manager/energy-stats` | 获取整体能耗统计 | 🟡 |
| | GET | `/api/manager/daily-stats` | 获取每日统计数据 | 🟡 |

**总计**: 23 个 HTTP 接口

---

### 9.2 房型价格配置

| 房型代码 | 房型名称 | 价格（元/晚） | 适用房间号 |
|---------|---------|-------------|-----------|
| single | 标准单人房 | ¥128 | 301, 304, 307, ... |
| double | 标准双人房 | ¥168 | 302, 305, 308, ... |
| king | 大床房 | ¥198 | 303, 306, 309, ... |

**房间分配规则**:
- 房间号 % 3 === 0 → 大床房
- 房间号 % 2 === 0 → 双人房
- 其他 → 单人房

---

### 9.3 费用计算公式

#### 空调费用计算

**费率配置**:
| 风速 | 费率（元/分钟） | 功率（kW） |
|------|----------------|-----------|
| Low | 0.5 | 0.8 |
| Mid | 0.8 | 1.0 |
| High | 1.0 | 1.2 |

**累加公式**:
```
每2秒累加 = 当前费率 × (2 / 60)

示例（中风）:
费用增量 = 0.8 × (2/60) = 0.0267 元
```

**能耗计算**:
```
能耗 (kWh) = 功率 (kW) × 时长 (小时)

示例（中风运行1小时）:
能耗 = 1.0 × 1 = 1.0 kWh
```

---

#### 住宿费用计算

**计算公式**:
```
住宿费 = 房价 × 入住天数

入住天数计算规则：
- 不足一天按一天计算
- 入住时间和退房时间向上取整到天数

示例：
2025-01-15 14:30 入住
2025-01-16 10:30 退房
天数 = ceiling((退房时间 - 入住时间) / 24小时) = 1天
住宿费 = 128 × 1 = 128元
```

**总账单**:
```
总费用 = 住宿费 + 空调费
```

---

### 9.4 WebSocket 事件完整列表

#### 客户端事件

**发送事件**:
| 事件名 | 参数 | 说明 |
|--------|------|------|
| join-room | { roomId } | 加入房间频道 |
| leave-room | { roomId } | 离开房间频道 |

**接收事件**:
| 事件名 | 参数 | 推送频率 | 说明 |
|--------|------|---------|------|
| temperature-update | { roomId, currentTemp } | 每2秒 | 温度更新 |
| fee-update | { roomId, totalFee } | 每2秒 | 费用更新 |
| status-change | { roomId, status, waitTime } | 状态改变时 | 服务状态变化 |
| service-started | { roomId } | 服务开始时 | 进入服务队列 |
| service-stopped | { roomId } | 服务停止时 | 关机或中央空调关闭 |

---

#### 管理员事件

**发送事件**:
| 事件名 | 参数 | 说明 |
|--------|------|------|
| join-admin | 无 | 加入管理员频道 |
| leave-admin | 无 | 离开管理员频道 |

**接收事件**:
| 事件名 | 参数 | 推送时机 | 说明 |
|--------|------|---------|------|
| central-ac-status | { isRunning, mode, currentServing } | 中央空调状态变化时 | 中央空调状态更新 |
| queue-update | { serviceQueue, waitingQueue } | 队列变化时 | 服务队列和等待队列更新 |
| room-power-on | { roomId, status } | 房间开机时 | 房间开机通知 |
| room-power-off | { roomId } | 房间关机时 | 房间关机通知 |

---

### 9.5 温度限制和业务规则

#### 温度范围
| 模式 | 最低温度 | 最高温度 | 默认目标温度 |
|------|---------|---------|-------------|
| Cooling（制冷） | 18°C | 25°C | 25°C |
| Heating（制热） | 25°C | 30°C | 26°C |

**调节步长**: 0.5°C

---

#### 服务队列规则

| 规则 | 说明 |
|------|------|
| 最大服务数 | 30个房间 |
| 队列管理 | 先到先服务（FIFO） |
| 等待提示 | 显示预计等待时间 |
| 优先级调度 | 可选功能，高风速可能抢占低风速 |

---

#### 房间状态转换

```
available（空闲）
    ↓ 办理入住
occupied（已入住）
    ↓ 退房结账
available（空闲）
```

```
idle（空闲）
    ↓ 开机
serving（服务中）或 waiting（等待中）
    ↓ 关机
idle（空闲）
```

---

### 9.6 错误码规范（可选）

建议定义统一的错误码：

| 错误码 | 说明 | HTTP状态码 |
|--------|------|-----------|
| SUCCESS | 成功 | 200 |
| INVALID_PARAM | 参数错误 | 400 |
| ROOM_NOT_FOUND | 房间不存在 | 404 |
| AC_NOT_RUNNING | 中央空调未启动 | 400 |
| ROOM_OCCUPIED | 房间已被占用 | 400 |
| QUEUE_FULL | 服务队列已满 | 503 |
| INTERNAL_ERROR | 服务器内部错误 | 500 |

---

## 🎓 10. 开发建议

### 10.1 后端技术选型建议

- **Node.js + Express**: 与前端技术栈一致，易于集成
- **Socket.io**: WebSocket 库，与前端完全兼容
- **数据库**: 可选 MongoDB、MySQL、SQLite
- **内存存储**: 开发阶段可以不用数据库，直接内存存储

---

### 10.2 实现顺序建议

1. **第一步**: 实现客户端核心接口（开关机、调温度、调风速）
2. **第二步**: 实现 WebSocket 推送（温度、费用）
3. **第三步**: 实现管理员端（中央空调控制）
4. **第四步**: 实现前台营业员端（入住结账）
5. **第五步**: 实现经理端（统计报表）

---

### 10.3 数据持久化建议

**必须持久化的数据**:
- ✅ 房间信息（房间号、房型、状态）
- ✅ 客户信息（姓名、身份证、入住时间）
- ✅ 空调使用记录（用于生成详单）
- ✅ 费用记录（用于账单）

**可以不持久化的数据**:
- ⭕ 当前温度（实时计算）
- ⭕ 服务队列（内存管理）
- ⭕ WebSocket 连接状态（运行时状态）

---

### 10.4 性能优化建议

1. **WebSocket 推送频率**: 2秒一次，不要太频繁
2. **温度变化模拟**: 每次向目标温度靠近10%
3. **队列管理**: 使用内存队列，避免频繁数据库操作
4. **批量查询**: 获取所有房间状态时，使用批量查询

---

## 📞 11. 联系与支持

### 文档说明

- 本文档包含所有 23 个 HTTP 接口的完整规范
- 包含所有 WebSocket 事件的详细说明
- 包含业务规则、费用计算公式、测试方法

### 测试环境

- **Mock Server**: 已提供完整的模拟服务器
- **启动命令**: `npm run mock`
- **访问地址**: `http://localhost:3000`

### 前端项目

- **启动命令**: `npm run dev`
- **访问地址**: `http://localhost:5173`
- **客户端**: `http://localhost:5173/room/301`
- **管理员**: `http://localhost:5173/admin`
- **前台**: `http://localhost:5173/reception`
- **经理**: `http://localhost:5173/manager`

---

**祝开发顺利！** 🎉

---

**文档版本**: v1.0
**最后更新**: 2025-01-25
**维护者**: 前端团队
